#include<stdio.h>
#include"jpeg.h"

int huffDC_co_0[]={0,2,3,4,5,6,14,30,62,126,254,510};
int huffDC_si_0[]={2,3,3,3,3,3,4,5,6,7,8,9};
int huffDC_co_1[]={0,1,2,6,14,30,62,126,254,510,1022,2046};
int huffDC_si_1[]={2,2,2,3,4,5,6,7,8,9,10,11};

int huffAC_co_0[]={10,0,1,4,11,26,120,248,1014,65410,65411,-1,-1,-1,-1,-1,-1,12,27,121,502,2038,65412,65413,65414,65415,65416,-1,-1,-1,-1,-1,-1,28,249,1015,4084,65417,65418,65419,65420,65421,65422,-1,-1,-1,-1,-1,-1,58,503,4085,65423,65424,65425,65426,65427,65428,65429,-1,-1,-1,-1,-1,-1,59,1016,65430,65431,65432,65433,65434,65435,65436,65437,-1,-1,-1,-1,-1,-1,122,2039,65438,65439,65440,65441,65442,65443,65444,65445,-1,-1,-1,-1,-1,-1,123,4086,65446,65447,65448,65449,65450,65451,65452,65453,-1,-1,-1,-1,-1,-1,250,4087,65454,65455,65456,65457,65458,65459,65460,65461,-1,-1,-1,-1,-1,-1,504,32704,65462,65463,65464,65465,65466,65467,65468,65469,-1,-1,-1,-1,-1,-1,505,65470,65471,65472,65473,65474,65475,65476,65477,65478,-1,-1,-1,-1,-1,-1,506,65479,65480,65481,65482,65483,65484,65485,65486,65487,-1,-1,-1,-1,-1,-1,1017,65488,65489,65490,65491,65492,65493,65494,65495,65496,-1,-1,-1,-1,-1,-1,1018,65497,65498,65499,65500,65501,65502,65503,65504,65505,-1,-1,-1,-1,-1,-1,2040,65506,65507,65508,65509,65510,65511,65512,65513,65514,-1,-1,-1,-1,-1,-1,65515,65516,65517,65518,65519,65520,65521,65522,65523,65524,-1,-1,-1,-1,-1,2041,65525,65526,65527,65528,65529,65530,65531,65532,65533,65534,-1,-1,-1,-1,-1};
int huffAC_si_0[]={4,2,2,3,4,5,7,8,10,16,16,0,0,0,0,0,0,4,5,7,9,11,16,16,16,16,16,0,0,0,0,0,0,5,8,10,12,16,16,16,16,16,16,0,0,0,0,0,0,6,9,12,16,16,16,16,16,16,16,0,0,0,0,0,0,6,10,16,16,16,16,16,16,16,16,0,0,0,0,0,0,7,11,16,16,16,16,16,16,16,16,0,0,0,0,0,0,7,12,16,16,16,16,16,16,16,16,0,0,0,0,0,0,8,12,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,15,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,10,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,10,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,11,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,16,16,16,16,16,16,16,16,16,16,0,0,0,0,0,11,16,16,16,16,16,16,16,16,16,16,0,0,0,0,0};
int huffAC_co_1[]={0,1,4,10,24,25,56,120,500,1014,4084,-1,-1,-1,-1,-1,-1,11,57,246,501,2038,4085,65416,65417,65418,65419,-1,-1,-1,-1,-1,-1,26,247,1015,4086,32706,65420,65421,65422,65423,65424,-1,-1,-1,-1,-1,-1,27,248,1016,4087,65425,65426,65427,65428,65429,65430,-1,-1,-1,-1,-1,-1,58,502,65431,65432,65433,65434,65435,65436,65437,65438,-1,-1,-1,-1,-1,-1,59,1017,65439,65440,65441,65442,65443,65444,65445,65446,-1,-1,-1,-1,-1,-1,121,2039,65447,65448,65449,65450,65451,65452,65453,65454,-1,-1,-1,-1,-1,-1,122,2040,65455,65456,65457,65458,65459,65460,65461,65462,-1,-1,-1,-1,-1,-1,249,65463,65464,65465,65466,65467,65468,65469,65470,65471,-1,-1,-1,-1,-1,-1,503,65472,65473,65474,65475,65476,65477,65478,65479,65480,-1,-1,-1,-1,-1,-1,504,65481,65482,65483,65484,65485,65486,65487,65488,65489,-1,-1,-1,-1,-1,-1,505,65490,65491,65492,65493,65494,65495,65496,65497,65498,-1,-1,-1,-1,-1,-1,506,65499,65500,65501,65502,65503,65504,65505,65506,65507,-1,-1,-1,-1,-1,-1,2041,65508,65509,65510,65511,65512,65513,65514,65515,65516,-1,-1,-1,-1,-1,-1,16352,65517,65518,65519,65520,65521,65522,65523,65524,65525,-1,-1,-1,-1,-1,1018,32707,65526,65527,65528,65529,65530,65531,65532,65533,65534,-1,-1,-1,-1,-1};
int huffAC_si_1[]={2,2,3,4,5,5,6,7,9,10,12,0,0,0,0,0,0,4,6,8,9,11,12,16,16,16,16,0,0,0,0,0,0,5,8,10,12,15,16,16,16,16,16,0,0,0,0,0,0,5,8,10,12,16,16,16,16,16,16,0,0,0,0,0,0,6,9,16,16,16,16,16,16,16,16,0,0,0,0,0,0,6,10,16,16,16,16,16,16,16,16,0,0,0,0,0,0,7,11,16,16,16,16,16,16,16,16,0,0,0,0,0,0,7,11,16,16,16,16,16,16,16,16,0,0,0,0,0,0,8,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,9,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,11,16,16,16,16,16,16,16,16,16,0,0,0,0,0,0,14,16,16,16,16,16,16,16,16,16,0,0,0,0,0,10,15,16,16,16,16,16,16,16,16,16,0,0,0,0,0};


extern volatile unsigned int *COPput, *COPget;

extern int Hput_buffer;
extern int Hput_bits;
extern FILE *Hfile_out;


void emiteBits(unsigned short code, int size)
{


/////////////////////////////////////////////////////////////////////////////////////////


//  AQUÍ DEBES PONER EL NUEVO CODIGO PARA emiteBits()

// ( SOLO SEGUNDA PARTE DE LA PRÁCTICA ) 

//  ESE CÓDIGO UTILIZARÁ EL COPROCESADOR Y SERÁ ALGO MÁS RÁPIDO (CUANTO)



/////////////////////////////////////////////////////////////////////////////////////////


// A CONTINUACIÓN, EL CÓDIGO NORMAL PARA emiteBits()

  register long int put_buffer = (long int) code;
  register int put_bits = Hput_bits;

  put_buffer &= (((long int) 1)<<size) - 1; // elimina cualquier bit sobrante del código
  
  put_bits += size;							// nuevo número de bits en el buffer 
  
  put_buffer <<= 24 - put_bits;				// alinea los bits entrantes

  put_buffer |= Hput_buffer;				// y los mezcla con los que ya están en el buffer
  
  while (put_bits >= 8) {				// si hemos juntado 8 bits o más, entonces emitimos 1 byte
    int c = (int) ((put_buffer >> 16) & 0xFF);
    fputc(c, Hfile_out);
    if (c == 0xFF) {					// en JPEG se debe insertar un 0 de relleno después de cada 0xFF
	fputc(0, Hfile_out);
    }
    put_buffer <<= 8;
    put_bits -= 8;
  }

  Hput_buffer = put_buffer;					// actualiza las variables que gestionan el buffer
  Hput_bits = put_bits;

}



void procesadorValores(int dcAC, int tipoBlock, int RL, short valor){

	short temp, temp2;
	int nbits, codigo;

	int *SizeTable, *CodeTable;

	if(tipoBlock==0){		// para codificar con Huffman, elegimos aquí las tablas que tocan 
		if(dcAC==esDC){
			SizeTable=huffDC_si_0;
			CodeTable=huffDC_co_0;
		}else{
			SizeTable=huffAC_si_0;
			CodeTable=huffAC_co_0;
		}
	}else{
		if(dcAC==esDC){
			SizeTable=huffDC_si_1;
			CodeTable=huffDC_co_1;
		}else{
			SizeTable=huffAC_si_1;
			CodeTable=huffAC_co_1;
		}
	}


	// nos preparamos para codificar el valor del coeficiente
	if (valor < 0) {
		temp = -valor;		temp2 = valor - 1;
	}else{
		temp = temp2 = valor;
	}
  
	// Calculamos el número de bits necesarios para codificar el valor del coeficiente;
	nbits = 0;
	while (temp) {
	    nbits++;
		temp >>= 1;
	}
	if(dcAC == esDC)
		codigo = nbits;
	else
		codigo = (RL << 4) + nbits;	

	emiteBits(CodeTable[codigo], SizeTable[codigo]);

	if(nbits)		// si el coeficiente no era 0, todavía hay que indicar cual es su valor	
		emiteBits((unsigned int)temp2, nbits);

}


void terminarHuffman(){

/////////////////////////////////////////////////////////////////////////////////////////


//  AQUÍ DEBES PONER EL NUEVO CODIGO PARA terminarHuffman()

// ( SOLO SEGUNDA PARTE DE LA PRÁCTICA ) 

//  ESE CÓDIGO UTILIZARÁ EL COPROCESADOR 


/////////////////////////////////////////////////////////////////////////////////////////


// A CONTINUACIÓN, EL CÓDIGO NORMAL PARA terminarHuffman()

	if(Hput_bits){
		int c = (int) ((Hput_buffer >> 16) & 0xFF);
    
		fputc(c, Hfile_out);
		if (c == 0xFF) {		// need to stuff a zero byte?
			fputc(0, Hfile_out);
		}
		Hput_buffer = Hput_bits = 0;
	}

}


